<script>
var stripe = Stripe('<%= STRIPE_PUBLISH_KEY %>');
var card;
$(document).ready(function(){
	<% if (setting!=undefined) { %>
		let setting=<%- JSON.stringify(setting) %>;
		console.log(setting);
		let expenseCat='',userRole='',address='';

		$("#companyStreet").val(setting.street);
		$("#companyCity").val(setting.city);
		$("#companyState").val(setting.state);
		$("#companyCountry").val(setting.country);
		$("#companyZip").val(setting.zip_code);
		$("#companyCurrency").val(setting.currency);
		$("#timezone").val(setting.timezone);
		$("#weekstartday").val(setting.weekstartday);

	<% } %>


})
function addNewExpenseCat(){

	let expenseCategory=$("#expenseCategoryInput").val().trim();
	if(expenseCategory!=''){
		$("#expenseCatDiv").val($("#expenseCatDiv").val()+expenseCategory+"\n");
		/*$("#expenseCatDiv").append('\n');*/
		$("#expenseCategoryInput").val('');
	}

}

function saveCompanyGeneralSetting(){
	showLoader('#globalLoader');
	let settingData = createJSONForFormData('#orgSettingGeneral');
	console.log(settingData);
	$.ajax({
	      type: 'POST',
	      url : '/editCompanySetting',
	      contentType: 'application/json',
	      dataType: 'json',
	      data:JSON.stringify(settingData),
	       success : function(response){
			   if(response.success){
					setTimeout(function(){
						hideLoader('#globalLoader');
						showGlobalToast('#globalToast', 'success', response.message, 4000);
					},2000);
					setTimeout(location.reload(),8000);;
			   }
	        },
	       error: function(response){
                console.log('error is : '+JSON.stringify(response));
                hideLoader('#globalLoader');
                showGlobalToast('#globalToast', 'error', response.responseJSON.message, 4000);
	        }
	    });

}
function disableIntegration(){
	showLoader('#globalLoader');
	$.ajax({
				type: 'POST',
				url : '/disableStripe',
				success : function(response){
						hideLoader('#globalLoader');
						closeModal('#modalAddPaymentDetail');
						$("button[enableIntegration]").show();
						$("button[disableIntegration]").hide();
						$("#integration-dashboard").hide();
						console.log('response is : '+JSON.stringify(response));
				},
				error: function(response){
					hideLoader('#globalLoader');
					showGlobalToast('#globalToast', 'error', response.responseJSON.message, 4000);
					setTimeout(function(){
						location.reload();
					},5000)
					console.log('error is : '+JSON.stringify(response));

				}
			});
}

function checkPaymentAndAdd(){
	showLoader('#globalLoader');
	stripe.createToken(card).then(function(result) {
    if (result.error) {
      // Inform the user if there was an error.
			hideLoader('#globalLoader');
      var errorElement = document.getElementById('card-errors');
      errorElement.textContent = result.error.message;
    } else {
      // Send the token to your server.
      // stripeTokenHandler(result.token);
			$.ajax({
						type: 'POST',
						url : '/initiateStripe',
						contentType: 'application/json',
						dataType :'json',
						data:JSON.stringify({stripeToken:result.token.id}),
						success : function(response){
								hideLoader('#globalLoader');
								closeModal('#modalAddPaymentDetail');
								$("button[enableIntegration]").hide();
								$("button[disableIntegration]").show();
								$("#integration-dashboard").show();
								console.log('response is : '+JSON.stringify(response));
						},
						error: function(response){
							hideLoader('#globalLoader');
							showGlobalToast('#globalToast', 'error', response.responseJSON.message, 4000);
							setTimeout(function(){
								location.reload();
							},5000)
							console.log('error is : '+JSON.stringify(response));

						}
					});
    }
  });

}

function enableIntegration(){
	var elements = stripe.elements();
	card = elements.create('card', {
	  hidePostalCode: true,
	  style: {
	    base: {
	      iconColor: '#F99A52',
	      color: '#32315E',
	      lineHeight: '48px',
	      fontWeight: 400,
	      fontFamily: '"Open Sans", "Helvetica Neue", "Helvetica", sans-serif',
	      fontSize: '15px',

	      '::placeholder': {
	        color: '#CFD7DF',
	      }
	    },
	  }
	});
	card.mount('#card-element');
	// $("#paymentDetail").show();

	openModal('#modalAddPaymentDetail')

}

// var form = document.getElementById('paymentDetail');
// form.addEventListener('submit', function(event) {
//   event.preventDefault();
//
//   stripe.createToken(card).then(function(result) {
//     if (result.error) {
//       // Inform the user if there was an error.
//       var errorElement = document.getElementById('card-errors');
//       errorElement.textContent = result.error.message;
//     } else {
//       // Send the token to your server.
//       stripeTokenHandler(result.token);
//     }
//   });
// });
//
// // Submit the form with the token ID.
// function stripeTokenHandler(token) {
//   // Insert the token ID into the form so it gets submitted to the server
//   var form = document.getElementById('paymentDetail');
//   var hiddenInput = document.createElement('input');
//   hiddenInput.setAttribute('type', 'hidden');
//   hiddenInput.setAttribute('name', 'stripeToken');
//   hiddenInput.setAttribute('value', token.id);
//   form.appendChild(hiddenInput);
//
//   // Submit the form
//   form.submit();
// }
</script>
